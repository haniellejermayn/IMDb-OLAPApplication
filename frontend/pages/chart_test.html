<!DOCTYPE html>
<html>
<head>
    <title>Chart Test Page</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-3.1.0.min.js" charset="utf-8"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        #testContainer {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        h2 {
            color: #555;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        .info {
            padding: 15px;
            background: #e8eaf6;
            border-left: 4px solid #667eea;
            margin-bottom: 25px;
            border-radius: 6px;
            font-size: 14px;
            color: #333;
        }
        #chartContainer {
            position: relative;
            min-height: 500px;
            margin-top: 20px;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        /* Form Styles */
        .form-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }
        .form-group input,
        .form-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group small {
            color: #777;
            font-size: 11px;
        }
        .required::after {
            content: " *";
            color: #e53e3e;
        }
        .report-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .report-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .report-btn.active {
            background: #667eea;
            color: white;
        }
        .report-btn:hover {
            background: #667eea;
            color: white;
        }
        .submit-btn {
            padding: 14px 32px;
            font-size: 16px;
            margin-top: 20px;
        }
        .hidden {
            display: none;
        }
        #statusMessage {
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-weight: 500;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div id="testContainer">
        <h1>Chart Test Page</h1>
        
        <div class="info">
            <strong>Quick Test:</strong> Use the buttons below to test charts with sample data, or select a report and fill in parameters to fetch real data from your backend.
        </div>

        <div class="test-buttons">
            <button onclick="testR1Chart()">Test R1 (Sample)</button>
            <button onclick="testR2Chart()">Test R2 (Sample)</button>
            <button onclick="testR3Chart()">Test R3 (Sample)</button>
            <button onclick="testR4Chart()">Test R4 (Sample)</button>
            <button onclick="testR5Chart()">Test R5 (Sample)</button>
        </div>

        <h2>Fetch Real Data</h2>
        
        <div class="report-selector">
            <button class="report-btn" onclick="selectReport('R1')">R1: Genre-Rating</button>
            <button class="report-btn" onclick="selectReport('R2')">R2: Runtime Trends</button>
            <button class="report-btn" onclick="selectReport('R3')">R3: Person Performance</button>
            <button class="report-btn" onclick="selectReport('R4')">R4: Genre Engagement</button>
            <button class="report-btn" onclick="selectReport('R5')">R5: TV Engagement</button>
        </div>

        <!-- R1 Form -->
        <div id="formR1" class="form-container hidden">
            <h3>R1: Genre-Rating Association</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="required">Time Granularity</label>
                    <select id="r1_time_granularity">
                        <option value="">Select</option>
                        <option value="year">Year</option>
                        <option value="decade">Decade</option>
                        <option value="era">Era</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Genres (comma-separated)</label>
                    <input type="text" id="r1_genres" placeholder="Action,Drama,Comedy">
                    <small>Leave empty for all genres</small>
                </div>
                <div class="form-group">
                    <label>Title Types (comma-separated)</label>
                    <input type="text" id="r1_title_types" placeholder="movie,tvSeries">
                </div>
                <div class="form-group">
                    <label>Start Year</label>
                    <input type="number" id="r1_start_year" placeholder="2015">
                </div>
                <div class="form-group">
                    <label>End Year</label>
                    <input type="number" id="r1_end_year" placeholder="2020">
                </div>
                <div class="form-group">
                    <label>Min Rating</label>
                    <input type="number" step="0.1" id="r1_min_rating" placeholder="7.0">
                </div>
                <div class="form-group">
                    <label>Min Votes</label>
                    <input type="number" id="r1_min_votes" placeholder="10000">
                </div>
                <div class="form-group">
                    <label>Runtime Min (minutes)</label>
                    <input type="number" id="r1_runtime_min" placeholder="60">
                </div>
                <div class="form-group">
                    <label>Runtime Max (minutes)</label>
                    <input type="number" id="r1_runtime_max" placeholder="180">
                </div>
            </div>
            <button class="submit-btn" onclick="fetchR1Data()">Fetch R1 Data</button>
        </div>
        
        <!-- Chi-Square Results Display -->
        <div id="chiSquareResults" class="hidden" style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #ffc107;">
            <h3 style="color: #856404; margin-bottom: 15px;">📊 Chi-Square Analysis Results</h3>
            <div id="chiSquareContent"></div>
        </div>

        <!-- R2 Form -->
        <div id="formR2" class="form-container hidden">
            <h3>R2: Runtime Trends by Type</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="required">Time Granularity</label>
                    <select id="r2_time_granularity">
                        <option value="">Select</option>
                        <option value="year">Year</option>
                        <option value="decade">Decade</option>
                        <option value="era">Era</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Genres (comma-separated)</label>
                    <input type="text" id="r2_genres" placeholder="Action,Drama">
                </div>
                <div class="form-group">
                    <label>Title Types (comma-separated)</label>
                    <input type="text" id="r2_title_types" placeholder="movie,tvSeries">
                </div>
                <div class="form-group">
                    <label>Start Year</label>
                    <input type="number" id="r2_start_year" placeholder="2015">
                </div>
                <div class="form-group">
                    <label>End Year</label>
                    <input type="number" id="r2_end_year" placeholder="2020">
                </div>
                <div class="form-group">
                    <label>Min Rating</label>
                    <input type="number" step="0.1" id="r2_min_rating" placeholder="7.0">
                </div>
                <div class="form-group">
                    <label>Min Votes</label>
                    <input type="number" id="r2_min_votes" placeholder="10000">
                </div>
                <div class="form-group">
                    <label>Runtime Min</label>
                    <input type="number" id="r2_runtime_min" placeholder="60">
                </div>
                <div class="form-group">
                    <label>Runtime Max</label>
                    <input type="number" id="r2_runtime_max" placeholder="180">
                </div>
            </div>
            <button class="submit-btn" onclick="fetchR2Data()">Fetch R2 Data</button>
        </div>

        <!-- R3 Form -->
        <div id="formR3" class="form-container hidden">
            <h3>R3: Person Performance Analysis</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="required">Job Category</label>
                    <select id="r3_job_category">
                        <option value="">Select</option>
                        <option value="actor">Actor</option>
                        <option value="actress">Actress</option>
                        <option value="archive_footage">Archive Footage</option>
                        <option value="archive_sound">Archive Sound</option>
                        <option value="casting_director">Casting Director</option>
                        <option value="cinematographer">Cinematographer</option>
                        <option value="composer">Composer</option>
                        <option value="director">Director</option>
                        <option value="editor">Editor</option>
                        <option value="producer">Producer</option>
                        <option value="production_designer">Production Designer</option>
                        <option value="self">Self</option>
                        <option value="writer">Writer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Additional Group By</label>
                    <select id="r3_group_by">
                        <option value="">None</option>
                        <option value="genre">Genre</option>
                        <option value="time_year">Year</option>
                        <option value="time_decade">Decade</option>
                        <option value="time_era">Era</option>
                    </select>
                    <small>Optional: further breakdown the data</small>
                </div>
                <div class="form-group">
                    <label>Genres (comma-separated)</label>
                    <input type="text" id="r3_genres" placeholder="Action,Drama">
                </div>
                <div class="form-group">
                    <label>Title Types (comma-separated)</label>
                    <input type="text" id="r3_title_types" placeholder="movie,tvSeries">
                </div>
                <div class="form-group">
                    <label>Start Year</label>
                    <input type="number" id="r3_start_year" placeholder="2015">
                </div>
                <div class="form-group">
                    <label>End Year</label>
                    <input type="number" id="r3_end_year" placeholder="2020">
                </div>
                <div class="form-group">
                    <label>Min Rating</label>
                    <input type="number" step="0.1" id="r3_min_rating" placeholder="7.0">
                </div>
                <div class="form-group">
                    <label>Min Votes</label>
                    <input type="number" id="r3_min_votes" placeholder="10000">
                </div>
                <div class="form-group">
                    <label>Min Titles (HAVING filter)</label>
                    <input type="number" id="r3_min_titles" placeholder="5">
                    <small>Minimum number of titles per person</small>
                </div>
            </div>
            <button class="submit-btn" onclick="fetchR3Data()">Fetch R3 Data</button>
        </div>

        <!-- R4 Form -->
        <div id="formR4" class="form-container hidden">
            <h3>R4: Genre Engagement</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Additional Group By</label>
                    <select id="r4_group_by">
                        <option value="">None</option>
                        <option value="time_year">Year</option>
                        <option value="time_decade">Decade</option>
                        <option value="time_era">Era</option>
                    </select>
                    <small>Optional: breakdown by time period</small>
                </div>
                <div class="form-group">
                    <label>Genres (comma-separated)</label>
                    <input type="text" id="r4_genres" placeholder="Action,Drama">
                </div>
                <div class="form-group">
                    <label>Title Types (comma-separated)</label>
                    <input type="text" id="r4_title_types" placeholder="movie,tvSeries">
                </div>
                <div class="form-group">
                    <label>Start Year</label>
                    <input type="number" id="r4_start_year" placeholder="2015">
                </div>
                <div class="form-group">
                    <label>End Year</label>
                    <input type="number" id="r4_end_year" placeholder="2020">
                </div>
                <div class="form-group">
                    <label>Min Rating</label>
                    <input type="number" step="0.1" id="r4_min_rating" placeholder="7.0">
                </div>
                <div class="form-group">
                    <label>Vote Min</label>
                    <input type="number" id="r4_vote_min" placeholder="1000">
                </div>
                <div class="form-group">
                    <label>Vote Max</label>
                    <input type="number" id="r4_vote_max" placeholder="1000000">
                </div>
            </div>
            <button class="submit-btn" onclick="fetchR4Data()">Fetch R4 Data</button>
        </div>

        <!-- R5 Form -->
        <div id="formR5" class="form-container hidden">
            <h3>R5: TV Series Engagement</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="required">TV Level</label>
                    <select id="r5_tv_level">
                        <option value="">Select</option>
                        <option value="episode">Episode</option>
                        <option value="season">Season</option>
                        <option value="series">Series</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Additional Group By</label>
                    <select id="r5_group_by">
                        <option value="">None</option>
                        <option value="genre">Genre</option>
                        <option value="time_year">Year</option>
                        <option value="time_decade">Decade</option>
                        <option value="time_era">Era</option>
                    </select>
                    <small>Optional: further breakdown the data</small>
                </div>
                <div class="form-group">
                    <label>Genres (comma-separated)</label>
                    <input type="text" id="r5_genres" placeholder="Action,Drama">
                </div>
                <div class="form-group">
                    <label>Title Types (comma-separated)</label>
                    <input type="text" id="r5_title_types" placeholder="tvSeries,tvMiniSeries">
                </div>
                <div class="form-group">
                    <label>Start Year</label>
                    <input type="number" id="r5_start_year" placeholder="2015">
                </div>
                <div class="form-group">
                    <label>End Year</label>
                    <input type="number" id="r5_end_year" placeholder="2020">
                </div>
                <div class="form-group">
                    <label>Min Rating</label>
                    <input type="number" step="0.1" id="r5_min_rating" placeholder="7.0">
                </div>
                <div class="form-group">
                    <label>Min Votes</label>
                    <input type="number" id="r5_min_votes" placeholder="10000">
                </div>
                <div class="form-group">
                    <label>Completion Status</label>
                    <select id="r5_completion_status">
                        <option value="">Any</option>
                        <option value="ended">Ended</option>
                        <option value="ongoing">Ongoing</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Series Name</label>
                    <input type="text" id="r5_series_name" placeholder="Breaking Bad">
                    <small>LIKE search on series title</small>
                </div>
                <div class="form-group">
                    <label>Season Number</label>
                    <input type="number" id="r5_season_number" placeholder="1">
                </div>
            </div>
            <button class="submit-btn" onclick="fetchR5Data()">Fetch R5 Data</button>
        </div>

        <div id="statusMessage" class="hidden"></div>

        <div id="chartContainer">
            <canvas id="resultsChart"></canvas>
        </div>
    </div>

    <script>
        let currentChart = null;
        let currentReport = null;

        // Report selection
        function selectReport(report) {
            currentReport = report;
            
            // Hide all forms
            document.querySelectorAll('.form-container').forEach(form => {
                form.classList.add('hidden');
            });
            
            // Update button states
            document.querySelectorAll('.report-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show selected form
            document.getElementById(`form${report}`).classList.remove('hidden');
            
            // Hide status message
            document.getElementById('statusMessage').classList.add('hidden');
            
            // Hide chi-square results when switching reports
            document.getElementById('chiSquareResults').classList.add('hidden');
        }

        // Helper function to show status messages
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = isError ? 'error' : 'success';
            statusEl.classList.remove('hidden');
        }

        // Helper to parse comma-separated values
        function parseArray(value) {
            if (!value || value.trim() === '') return null;
            return value.split(',').map(v => v.trim());
        }

        // R1 Data Fetcher
        async function fetchR1Data() {
            const payload = {
                time_granularity: document.getElementById('r1_time_granularity').value
            };

            if (!payload.time_granularity) {
                showStatus('Time Granularity is required for R1!', true);
                return;
            }

            // Optional filters
            const genres = parseArray(document.getElementById('r1_genres').value);
            if (genres) payload.genres = genres;
            
            const titleTypes = parseArray(document.getElementById('r1_title_types').value);
            if (titleTypes) payload.title_types = titleTypes;
            
            const startYear = document.getElementById('r1_start_year').value;
            if (startYear) payload.start_year = parseInt(startYear);
            
            const endYear = document.getElementById('r1_end_year').value;
            if (endYear) payload.end_year = parseInt(endYear);
            
            const minRating = document.getElementById('r1_min_rating').value;
            if (minRating) payload.min_rating = parseFloat(minRating);
            
            const minVotes = document.getElementById('r1_min_votes').value;
            if (minVotes) payload.min_votes = parseInt(minVotes);
            
            const runtimeMin = document.getElementById('r1_runtime_min').value;
            if (runtimeMin) payload.runtime_min = parseInt(runtimeMin);
            
            const runtimeMax = document.getElementById('r1_runtime_max').value;
            if (runtimeMax) payload.runtime_max = parseInt(runtimeMax);

            // Always calculate chi-square for R1
            payload.calculate_chi_square = true;

            await fetchData('/api/reports/r1', payload, 'R1');
        }

        // R2 Data Fetcher
        async function fetchR2Data() {
            const payload = {
                time_granularity: document.getElementById('r2_time_granularity').value
            };

            if (!payload.time_granularity) {
                showStatus('Time Granularity is required for R2!', true);
                return;
            }

            const genres = parseArray(document.getElementById('r2_genres').value);
            if (genres) payload.genres = genres;
            
            const titleTypes = parseArray(document.getElementById('r2_title_types').value);
            if (titleTypes) payload.title_types = titleTypes;
            
            const startYear = document.getElementById('r2_start_year').value;
            if (startYear) payload.start_year = parseInt(startYear);
            
            const endYear = document.getElementById('r2_end_year').value;
            if (endYear) payload.end_year = parseInt(endYear);
            
            const minRating = document.getElementById('r2_min_rating').value;
            if (minRating) payload.min_rating = parseFloat(minRating);
            
            const minVotes = document.getElementById('r2_min_votes').value;
            if (minVotes) payload.min_votes = parseInt(minVotes);
            
            const runtimeMin = document.getElementById('r2_runtime_min').value;
            if (runtimeMin) payload.runtime_min = parseInt(runtimeMin);
            
            const runtimeMax = document.getElementById('r2_runtime_max').value;
            if (runtimeMax) payload.runtime_max = parseInt(runtimeMax);

            await fetchData('/api/reports/r2', payload, 'R2');
        }

        // R3 Data Fetcher
        async function fetchR3Data() {
            const payload = {
                job_category: document.getElementById('r3_job_category').value
            };

            if (!payload.job_category) {
                showStatus('Job Category is required for R3!', true);
                return;
            }

            // Get the additional group by value
            const groupBy = document.getElementById('r3_group_by').value;
            if (groupBy === 'genre') {
                payload.group_by_genre = true;
            } else if (groupBy.startsWith('time_')) {
                const granularity = groupBy.split('_')[1];
                payload.group_by_time = true;
                payload.time_granularity = granularity;
            }

            const genres = parseArray(document.getElementById('r3_genres').value);
            if (genres) payload.genres = genres;
            
            const titleTypes = parseArray(document.getElementById('r3_title_types').value);
            if (titleTypes) payload.title_types = titleTypes;
            
            const startYear = document.getElementById('r3_start_year').value;
            if (startYear) payload.start_year = parseInt(startYear);
            
            const endYear = document.getElementById('r3_end_year').value;
            if (endYear) payload.end_year = parseInt(endYear);
            
            const minRating = document.getElementById('r3_min_rating').value;
            if (minRating) payload.min_rating = parseFloat(minRating);
            
            const minVotes = document.getElementById('r3_min_votes').value;
            if (minVotes) payload.min_votes = parseInt(minVotes);
            
            const minTitles = document.getElementById('r3_min_titles').value;
            if (minTitles) payload.min_titles = parseInt(minTitles);

            await fetchData('/api/reports/r3', payload, 'R3');
        }

        // R4 Data Fetcher
        async function fetchR4Data() {
            const payload = {};

            // Get the additional group by value
            const groupBy = document.getElementById('r4_group_by').value;
            if (groupBy.startsWith('time_')) {
                const granularity = groupBy.split('_')[1];
                payload.time_granularity = granularity;
            }

            const genres = parseArray(document.getElementById('r4_genres').value);
            if (genres) payload.genres = genres;
            
            const titleTypes = parseArray(document.getElementById('r4_title_types').value);
            if (titleTypes) payload.title_types = titleTypes;
            
            const startYear = document.getElementById('r4_start_year').value;
            if (startYear) payload.start_year = parseInt(startYear);
            
            const endYear = document.getElementById('r4_end_year').value;
            if (endYear) payload.end_year = parseInt(endYear);
            
            const minRating = document.getElementById('r4_min_rating').value;
            if (minRating) payload.min_rating = parseFloat(minRating);
            
            const voteMin = document.getElementById('r4_vote_min').value;
            if (voteMin) payload.vote_min = parseInt(voteMin);
            
            const voteMax = document.getElementById('r4_vote_max').value;
            if (voteMax) payload.vote_max = parseInt(voteMax);

            await fetchData('/api/reports/r4', payload, 'R4');
        }

        // R5 Data Fetcher
        async function fetchR5Data() {
            const payload = {
                tv_level: document.getElementById('r5_tv_level').value
            };

            if (!payload.tv_level) {
                showStatus('TV Level is required for R5!', true);
                return;
            }

            // Get the additional group by value
            const groupBy = document.getElementById('r5_group_by').value;
            if (groupBy === 'genre') {
                payload.group_by_genre = true;
            } else if (groupBy.startsWith('time_')) {
                const granularity = groupBy.split('_')[1];
                payload.group_by_time = true;
                payload.time_granularity = granularity;
            }

            const genres = parseArray(document.getElementById('r5_genres').value);
            if (genres) payload.genres = genres;
            
            const titleTypes = parseArray(document.getElementById('r5_title_types').value);
            if (titleTypes) payload.title_types = titleTypes;
            
            const startYear = document.getElementById('r5_start_year').value;
            if (startYear) payload.start_year = parseInt(startYear);
            
            const endYear = document.getElementById('r5_end_year').value;
            if (endYear) payload.end_year = parseInt(endYear);
            
            const minRating = document.getElementById('r5_min_rating').value;
            if (minRating) payload.min_rating = parseFloat(minRating);
            
            const minVotes = document.getElementById('r5_min_votes').value;
            if (minVotes) payload.min_votes = parseInt(minVotes);
            
            const completionStatus = document.getElementById('r5_completion_status').value;
            if (completionStatus) payload.completion_status = completionStatus;
            
            const seriesName = document.getElementById('r5_series_name').value;
            if (seriesName) payload.series_name = seriesName;
            
            const seasonNumber = document.getElementById('r5_season_number').value;
            if (seasonNumber) payload.season_number = parseInt(seasonNumber);

            await fetchData('/api/reports/r5', payload, 'R5');
        }

        // Generic fetch function
        async function fetchData(endpoint, payload, reportType) {
            try {
                showStatus('Fetching data...', false);
                console.log(`Sending request to ${endpoint}:`, payload);

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log('Response:', result);

                if (result.status === 'success' && result.data) {
                    showStatus(`✓ Successfully fetched ${result.data.length} rows`, false);
                    renderChart(result.data, reportType);
                    
                    // Display chi-square results if present (R1 report)
                    if (result.chi_square_analysis) {
                        displayChiSquareResults(result.chi_square_analysis);
                    } else {
                        // Hide chi-square section if not present
                        document.getElementById('chiSquareResults').classList.add('hidden');
                    }
                } else {
                    showStatus('Error: ' + (result.message || 'Unknown error'), true);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showStatus('Failed to fetch data: ' + error.message, true);
            }
        }

        // Display Chi-Square Analysis Results
        function displayChiSquareResults(chiData) {
            const container = document.getElementById('chiSquareResults');
            const content = document.getElementById('chiSquareContent');
            
            if (!chiData || chiData.error) {
                container.classList.add('hidden');
                return;
            }
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #ffc107;">
                        <div style="font-size: 12px; color: #856404; margin-bottom: 5px;">Chi-Square Statistic</div>
                        <div style="font-size: 24px; font-weight: bold; color: #333;">${chiData.chi_square_statistic}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #ffc107;">
                        <div style="font-size: 12px; color: #856404; margin-bottom: 5px;">Degrees of Freedom</div>
                        <div style="font-size: 24px; font-weight: bold; color: #333;">${chiData.degrees_of_freedom}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #ffc107;">
                        <div style="font-size: 12px; color: #856404; margin-bottom: 5px;">Critical Value (α=0.05)</div>
                        <div style="font-size: 24px; font-weight: bold; color: #333;">${chiData['critical_value_alpha_0.05']}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #ffc107;">
                        <div style="font-size: 12px; color: #856404; margin-bottom: 5px;">Significance</div>
                        <div style="font-size: 18px; font-weight: bold; color: ${chiData.is_significant ? '#28a745' : '#dc3545'};">
                            ${chiData.is_significant ? '✓ Significant' : '✗ Not Significant'}
                        </div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ffc107;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #856404;">Interpretation:</div>
                    <div style="color: #333;">${chiData.interpretation}</div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ffc107;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #856404;">Summary Statistics:</div>
                    <div style="color: #333;">
                        <strong>Grand Total:</strong> ${chiData.grand_total.toLocaleString()} observations<br>
                    </div>
                </div>
            `;
            
            // Top contributions table
            if (chiData.top_contributions && chiData.top_contributions.length > 0) {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #ffc107;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #856404;">Top 10 Cell Contributions to Chi-Square:</div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                        <th style="padding: 8px; text-align: left;">Genre</th>
                                        <th style="padding: 8px; text-align: left;">Rating Bin</th>
                                        <th style="padding: 8px; text-align: right;">Observed</th>
                                        <th style="padding: 8px; text-align: right;">Expected</th>
                                        <th style="padding: 8px; text-align: right;">Contribution</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                chiData.top_contributions.forEach((contrib, idx) => {
                    html += `
                        <tr style="border-bottom: 1px solid #dee2e6; ${idx % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                            <td style="padding: 8px;">${contrib.genre}</td>
                            <td style="padding: 8px;">${contrib.rating_bin}</td>
                            <td style="padding: 8px; text-align: right;">${contrib.observed}</td>
                            <td style="padding: 8px; text-align: right;">${contrib.expected}</td>
                            <td style="padding: 8px; text-align: right; font-weight: bold; color: ${contrib.contribution > 10 ? '#dc3545' : '#333'};">${contrib.contribution}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            <em>Note: Higher contribution values indicate cells that deviate most from expected values under independence.</em>
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            container.classList.remove('hidden');
        }

        // Sample data generators (for testing)
        function generateR1Data() {
            return [
                { genre: 'Action', rating_bin: 'Low', time_period: 2020, count: 150 },
                { genre: 'Action', rating_bin: 'Mid', time_period: 2020, count: 450 },
                { genre: 'Action', rating_bin: 'High', time_period: 2020, count: 200 },
                { genre: 'Drama', rating_bin: 'Low', time_period: 2020, count: 100 },
                { genre: 'Drama', rating_bin: 'Mid', time_period: 2020, count: 400 },
                { genre: 'Drama', rating_bin: 'High', time_period: 2020, count: 300 },
                { genre: 'Action', rating_bin: 'Low', time_period: 2021, count: 120 },
                { genre: 'Action', rating_bin: 'Mid', time_period: 2021, count: 480 },
                { genre: 'Action', rating_bin: 'High', time_period: 2021, count: 250 },
            ];
        }

        function generateR2Data() {
            return [
                { time_period: 2018, titleType: 'movie', avg_runtime: 110.5 },
                { time_period: 2019, titleType: 'movie', avg_runtime: 115.2 },
                { time_period: 2020, titleType: 'movie', avg_runtime: 118.8 },
                { time_period: 2021, titleType: 'movie', avg_runtime: 120.1 },
                { time_period: 2018, titleType: 'tvSeries', avg_runtime: 42.3 },
                { time_period: 2019, titleType: 'tvSeries', avg_runtime: 43.1 },
                { time_period: 2020, titleType: 'tvSeries', avg_runtime: 44.5 },
                { time_period: 2021, titleType: 'tvSeries', avg_runtime: 45.2 },
            ];
        }

        function generateR3Data() {
            const names = ['Christopher Nolan', 'Steven Spielberg', 'Quentin Tarantino', 
                          'Martin Scorsese', 'James Cameron', 'Ridley Scott'];
            return names.map((name, i) => ({
                nconst: `nm${i}`,
                primaryName: name,
                avg_rating: 8.5 - (i * 0.3),
                total_titles: 20 - (i * 2)
            }));
        }

        function generateR4Data() {
            const genres = ['Action', 'Drama', 'Comedy', 'Thriller', 'Sci-Fi'];
            return genres.map(genre => ({
                genreName: genre,
                total_votes: Math.floor(Math.random() * 500000) + 100000,
                title_count: Math.floor(Math.random() * 100) + 50,
                avg_votes_per_title: Math.floor(Math.random() * 5000) + 1000,
                avg_rating: (Math.random() * 3 + 6).toFixed(1)
            }));
        }

        function generateR5Data() {
            return [
                { series_title: 'Breaking Bad', total_votes: 1500000, avg_rating: 9.5, episode_count: 62 },
                { series_title: 'Game of Thrones', total_votes: 1800000, avg_rating: 9.2, episode_count: 73 },
                { series_title: 'The Office', total_votes: 1200000, avg_rating: 8.9, episode_count: 201 },
                { series_title: 'Friends', total_votes: 1000000, avg_rating: 8.8, episode_count: 236 },
            ];
        }

        // Test functions
        function testR1Chart() {
            const data = generateR1Data();
            console.log('Testing R1 with data:', data);
            showStatus('Loaded sample R1 data', false);
            renderChart(data, 'R1');
        }

        function testR2Chart() {
            const data = generateR2Data();
            console.log('Testing R2 with data:', data);
            showStatus('Loaded sample R2 data', false);
            renderChart(data, 'R2');
        }

        function testR3Chart() {
            const data = generateR3Data();
            console.log('Testing R3 with data:', data);
            showStatus('Loaded sample R3 data', false);
            renderChart(data, 'R3');
        }

        function testR4Chart() {
            const data = generateR4Data();
            console.log('Testing R4 with data:', data);
            showStatus('Loaded sample R4 data', false);
            renderChart(data, 'R4');
        }

        function testR5Chart() {
            const data = generateR5Data();
            console.log('Testing R5 with data:', data);
            showStatus('Loaded sample R5 data', false);
            renderChart(data, 'R5');
        }

        // Main render table function for R3 to R5
        function renderGroupedTable(container, results, reportType, groupByField) {
            const groupedData = {};
            
            // Group results by the specified field
            results.forEach(row => {
                const groupKey = row[groupByField] || 'N/A';
                if (!groupedData[groupKey]) {
                    groupedData[groupKey] = [];
                }
                groupedData[groupKey].push(row);
            });
            
            // Determine column headers based on report type
            let columns = [];
            if (reportType === 'R2') {
                columns = ['time_period', 'titleType', 'avg_runtime', 'title_count', 'avg_rating'];
            } else if (reportType === 'R3') {
                columns = ['primaryName', 'avg_rating', 'total_titles'];
            } else if (reportType === 'R4') {
                columns = ['time_period', 'total_votes', 'title_count', 'avg_votes_per_title', 'avg_rating'];
            } else if (reportType === 'R5') {
                // Check what level of data we have
                const hasEpisodeNumber = results[0]?.episodeNumber !== undefined;
                const hasSeasonNumber = results[0]?.seasonNumber !== undefined;
                
                if (hasEpisodeNumber && hasSeasonNumber) {
                    // Episode level
                    columns = ['series_title', 'seasonNumber', 'episodeNumber', 'total_votes', 'avg_rating'];
                } else if (hasSeasonNumber) {
                    // Season level
                    columns = ['series_title', 'seasonNumber', 'episode_count', 'total_votes', 'avg_rating'];
                } else {
                    // Series level - check if we have season/episode counts
                    const hasSeasonCount = results[0]?.season_count !== undefined;
                    if (hasSeasonCount) {
                        columns = ['series_title', 'season_count', 'episode_count', 'total_votes', 'avg_rating'];
                    } else {
                        columns = ['series_title', 'episode_count', 'total_votes', 'avg_rating'];
                    }
                }
            }
            
            const columnLabels = {
                'time_period': 'Time Period',
                'titleType': 'Title Type',
                'avg_runtime': 'Avg Runtime (min)',
                'title_count': 'Title Count',
                'avg_rating': 'Avg Rating',
                'primaryName': 'Person',
                'total_titles': 'Total Titles',
                'total_votes': 'Total Votes',
                'avg_votes_per_title': 'Avg Votes/Title',
                'series_title': 'Series Title',
                'episode_count': 'Episodes',
                'season_count': 'Seasons',
                'seasonNumber': 'Season',
                'episodeNumber': 'Episode'
            };
            
            let html = '<div style="display: grid; gap: 30px;">';
            let totalGroups = Object.keys(groupedData).length;
            let groupCount = 0;
            
            Object.entries(groupedData).forEach(([groupName, data]) => {
                groupCount++;
                // Limit to top 10 per group and sort by most relevant metric
                let topData = data.slice(0, 10);
                
                html += `
                    <div style="border: 1px solid #ddd; padding: 20px; border-radius: 8px; background: white;">
                        <h3 style="margin-bottom: 5px; color: #333; font-size: 18px;">
                            ${groupName} <span style="font-size: 14px; color: #999; font-weight: normal;">([${groupCount}/${totalGroups}])</span>
                        </h3>
                        <p style="margin: 0 0 15px 0; font-size: 12px; color: #666;">Showing top ${topData.length} of ${data.length}</p>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                `;
                
                columns.forEach(col => {
                    html += `<th style="padding: 10px; text-align: left; font-weight: 600; white-space: nowrap;">${columnLabels[col] || col}</th>`;
                });
                
                html += `
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                topData.forEach((row, idx) => {
                    html += `<tr style="border-bottom: 1px solid #eee; ${idx % 2 === 0 ? 'background: #fafafa;' : ''}">`;
                    
                    columns.forEach(col => {
                        let value = row[col];
                        
                        // Special formatting for season and episode numbers
                        if (col === 'seasonNumber' && value !== undefined && value !== null) {
                            value = `S${String(value).padStart(2, '0')}`;
                        } else if (col === 'episodeNumber' && value !== undefined && value !== null) {
                            value = `E${String(value).padStart(2, '0')}`;
                        }
                        
                        // Format numeric values
                        if (typeof value === 'number') {
                            if (col.includes('rating')) {
                                value = value.toFixed(2);
                            } else if (col.includes('avg') && col.includes('runtime')) {
                                value = value.toFixed(1);
                            } else if (col.includes('votes') || col.includes('count')) {
                                value = Math.round(value).toLocaleString();
                            } else if (col.includes('titles')) {
                                value = Math.round(value);
                            }
                        }
                        html += `<td style="padding: 10px;">${value || 'N/A'}</td>`;
                    });
                    
                    html += `</tr>`;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Main render chart function
        function renderChart(results, reportType) {
            console.log("Rendering chart for report:", reportType, results);
            
            if (!results || results.length === 0) {
                console.warn("⚠️ No results to display in chart.");
                document.getElementById('chartContainer').innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">No data available to display.</p>';
                return;
            }

            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }

            const chartContainer = document.getElementById('chartContainer');
            
            // Check what grouping fields exist in the data
            const hasGenre = results[0]?.genreName !== undefined;
            const hasTimePeriod = results[0]?.time_period !== undefined;
            const hasTitleType = results[0]?.titleType !== undefined;
            
            console.log(`R${reportType.slice(1)} - hasGenre: ${hasGenre}, hasTimePeriod: ${hasTimePeriod}, hasTitleType: ${hasTitleType}`);
            
            // Use table view if optional grouping is present
            if (reportType === 'R3' && hasGenre) {
                renderGroupedTable(chartContainer, results, reportType, 'genreName');
                return;
            }
            if (reportType === 'R3' && hasTimePeriod) {
                renderGroupedTable(chartContainer, results, reportType, 'time_period');
                return;
            }
            if (reportType === 'R4' && hasTimePeriod) {
                renderGroupedTable(chartContainer, results, reportType, 'time_period');
                return;
            }
            if (reportType === 'R5' && hasGenre) {
                renderGroupedTable(chartContainer, results, reportType, 'genreName');
                return;
            }
            if (reportType === 'R5' && hasTimePeriod) {
                renderGroupedTable(chartContainer, results, reportType, 'time_period');
                return;
            }
            
            // Otherwise render chart as normal
            chartContainer.innerHTML = '<canvas id="resultsChart"></canvas>';
            const ctx = document.getElementById('resultsChart').getContext('2d');

            switch(reportType) {
                case 'R1':
                    renderR1Chart(ctx, results);
                    break;
                case 'R2':
                    renderR2Chart(ctx, results);
                    break;
                case 'R3':
                    renderR3Chart(ctx, results);
                    break;
                case 'R4':
                    renderR4Chart(ctx, results);
                    break;
                case 'R5':
                    renderR5Chart(ctx, results);
                    break;
                default:
                    console.error("Unknown report type:", reportType);
            }
        }

        // R1: Genre-Rating Association - Contingency Table + Heatmap
        function renderR1Chart(ctx, results) {
            const chartContainer = document.getElementById('chartContainer');
            
            const timePeriods = [...new Set(results.map(r => r.time_period))].sort();
            const genres = [...new Set(results.map(r => r.genre))].sort();
            const ratingBins = ['Very Low', 'Low', 'Mid', 'High', 'Very High'];
            
            // Build contingency table data structure
            const contingencyData = {};
            genres.forEach(genre => {
                contingencyData[genre] = {};
                ratingBins.forEach(bin => {
                    contingencyData[genre][bin] = {};
                    timePeriods.forEach(period => {
                        contingencyData[genre][bin][period] = 0;
                    });
                });
            });
            
            // Populate with actual data
            results.forEach(row => {
                if (contingencyData[row.genre] && contingencyData[row.genre][row.rating_bin]) {
                    contingencyData[row.genre][row.rating_bin][row.time_period] = row.count;
                }
            });
            
            // Show contingency tables by time period
            let html = `
                <div style="padding: 20px;">
                    <h3 style="margin: 0 0 10px 0; color: #333;">R1: Genre-Rating Association Analysis</h3>
                    <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">
                        Observed frequencies for chi-square contingency table analysis
                    </p>
            `;
            
            // Generate contingency table for each time period
            timePeriods.forEach((period, periodIdx) => {
                html += `
                    <div style="margin-bottom: 30px; ${periodIdx > 0 ? 'page-break-before: always;' : ''}">
                        <h4 style="margin: 0 0 15px 0; color: #667eea; font-size: 16px;">
                            Time Period: ${period}
                        </h4>
                        <div style="overflow-x: auto;">
                            <table style="border-collapse: collapse; font-size: 13px; width: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Genre</th>
                `;
                
                ratingBins.forEach(bin => {
                    html += `<th style="padding: 10px; text-align: center; border: 1px solid #ddd;">${bin}</th>`;
                });
                
                html += `
                                        <th style="padding: 10px; text-align: center; border: 1px solid #ddd; background: #5568d3;">Row Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                let columnTotals = {};
                ratingBins.forEach(bin => columnTotals[bin] = 0);
                let grandTotal = 0;
                
                genres.forEach((genre, idx) => {
                    html += `<tr style="${idx % 2 === 0 ? 'background: #fafafa;' : 'background: white;'}">`;
                    html += `<td style="padding: 10px; font-weight: 600; border: 1px solid #ddd;">${genre}</td>`;
                    
                    let rowTotal = 0;
                    ratingBins.forEach(bin => {
                        const count = contingencyData[genre][bin][period];
                        rowTotal += count;
                        columnTotals[bin] += count;
                        grandTotal += count;
                        
                        html += `<td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${count.toLocaleString()}</td>`;
                    });
                    
                    html += `<td style="padding: 10px; text-align: center; border: 1px solid #ddd; background: #f0f0f0; font-weight: 600;">${rowTotal.toLocaleString()}</td>`;
                    html += `</tr>`;
                });
                
                // Column totals row
                html += `
                                    <tr style="background: #e8eaf6; font-weight: 600;">
                                        <td style="padding: 10px; border: 1px solid #ddd;">Column Total</td>
                `;
                
                ratingBins.forEach(bin => {
                    html += `<td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${columnTotals[bin].toLocaleString()}</td>`;
                });
                
                html += `
                                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd; background: #667eea; color: white;">${grandTotal.toLocaleString()}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
            `;
            
            chartContainer.innerHTML = html;
        }

        // R2: Runtime Trends Chart
        function renderR2Chart(ctx, results) {
            const timePeriods = [...new Set(results.map(r => r.time_period))].sort();
            const titleTypes = [...new Set(results.map(r => r.titleType))];
            
            const colorPalette = [
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)'
            ];

            const datasets = titleTypes.map((type, index) => {
                const data = timePeriods.map(period => {
                    const entry = results.find(r => r.time_period === period && r.titleType === type);
                    return entry ? parseFloat(entry.avg_runtime) : null;
                });
                return {
                    label: type,
                    data: data,
                    borderColor: colorPalette[index % colorPalette.length],
                    backgroundColor: colorPalette[index % colorPalette.length].replace('0.7', '0.2'),
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4
                };
            });

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timePeriods,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Average Runtime Trends Over Time',
                            font: { size: 16 }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Time Period' }
                        },
                        y: {
                            title: { display: true, text: 'Average Runtime (minutes)' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // R3: Person Performance Chart
        function renderR3Chart(ctx, results) {
            const topResults = results
                .sort((a, b) => parseFloat(b.avg_rating) - parseFloat(a.avg_rating))
                .slice(0, 10);
            
            const labels = topResults.map(r => r.primaryName || r.nconst);
            const ratings = topResults.map(r => parseFloat(r.avg_rating));
            const titleCounts = topResults.map(r => parseInt(r.total_titles));

            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Average Rating',
                            data: ratings,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Total Titles',
                            data: titleCounts,
                            backgroundColor: 'rgba(255, 159, 64, 0.7)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 Person Performance by Average Rating',
                            font: { size: 16 }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Value' }
                        },
                        y: {
                            position: 'left',
                            title: { display: true, text: 'Average Rating' }
                        },
                        y1: {
                            position: 'right',
                            title: { display: true, text: 'Total Titles' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // R4: Genre Engagement Chart
        function renderR4Chart(ctx, results) {
            const hasTimePeriod = results[0]?.time_period !== undefined;
            
            if (hasTimePeriod) {
                const timePeriods = [...new Set(results.map(r => r.time_period))].sort();
                const genres = [...new Set(results.map(r => r.genreName))];
                
                const colorPalette = [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)'
                ];

                const datasets = genres.slice(0, 10).map((genre, index) => {
                    const data = timePeriods.map(period => {
                        const entry = results.find(r => r.time_period === period && r.genreName === genre);
                        return entry ? parseInt(entry.total_votes) : 0;
                    });
                    return {
                        label: genre,
                        data: data,
                        backgroundColor: colorPalette[index % colorPalette.length],
                        borderColor: colorPalette[index % colorPalette.length].replace('0.7', '1'),
                        borderWidth: 1
                    };
                });

                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: timePeriods,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Genre Engagement by Time Period',
                                font: { size: 16 }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Time Period' }
                            },
                            y: {
                                title: { display: true, text: 'Total Votes' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            } else {
                const sortedResults = results
                    .sort((a, b) => parseInt(b.total_votes) - parseInt(a.total_votes))
                    .slice(0, 10);
                
                const labels = sortedResults.map(r => r.genreName);
                const votes = sortedResults.map(r => parseInt(r.total_votes));

                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Votes',
                            data: votes,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Top 10 Genres by Total Engagement',
                                font: { size: 16 }
                            },
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Genre' }
                            },
                            y: {
                                title: { display: true, text: 'Total Votes' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        // R5: TV Series Engagement Chart
        function renderR5Chart(ctx, results) {
            const topResults = results
                .sort((a, b) => parseInt(b.total_votes) - parseInt(a.total_votes))
                .slice(0, 10);
            
            let labels;
            if (topResults[0].hasOwnProperty('episode_title')) {
                // Episode level - show series, season, and episode number
                labels = topResults.map(r => {
                    const season = String(r.seasonNumber).padStart(2, '0');
                    const episode = String(r.episodeNumber).padStart(2, '0');
                    return `${r.series_title} S${season}E${episode}`;
                });
            } else if (topResults[0].hasOwnProperty('seasonNumber')) {
                // Season level - show series and season
                labels = topResults.map(r => `${r.series_title} S${String(r.seasonNumber).padStart(2, '0')}`);
            } else {
                // Series level
                labels = topResults.map(r => r.series_title);
            }

            const votes = topResults.map(r => parseInt(r.total_votes));
            const ratings = topResults.map(r => parseFloat(r.avg_rating));

            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Votes',
                            data: votes,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Average Rating',
                            data: ratings,
                            backgroundColor: 'rgba(255, 206, 86, 0.7)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 TV Content by Engagement',
                            font: { size: 16 }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Value' }
                        },
                        y: {
                            position: 'left',
                            title: { display: true, text: 'Total Votes' }
                        },
                        y1: {
                            position: 'right',
                            title: { display: true, text: 'Average Rating' },
                            max: 10,
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Auto-load a test chart on page load
        window.addEventListener('DOMContentLoaded', () => {
            testR2Chart();
        });
    </script>
</body>
</html>